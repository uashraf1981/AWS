# AWS Key Management Service (KMS)

*If you HAVE compliance requirements and want to ensure that only you manage your keys, then use AWS CloudHSM*

*If you DON'T have compliance requirements, and want easier management for your keys, then use AWS KMS*

The basic idea is that you encrypt your data with the *Data Key*, but then you need to encrypt the data key as well. So you use a *Master Key* to encrypt your data key and AWS KMS stores the Master Key.

** AWS KMS does not store or allow you to use them inside AWS KMS, you must store and use them elsewhere **

** Remember the scope of keys is always a region **

<img src="https://github.com/uashraf1981/AWS/blob/master/AWS-KMS/Master%20Key.png"  align="center" width="300" height="150">

KMS Master Keys
---------------
AWS KMS Customer Master Keys (CMK) are *AES-256* *symmetric encoded* keys which never leave KMS and while a client can manipulate the Master Keys, it can never see the actual contents of the key itself. The client can create, delete and apply policies to who has access to Customer Master Keys (CMK). Typically used to encrypt/decrypt data encryption keys. It can encrypt data chunks as well but maximum of 4KB chunks.

![stack Overflow](https://github.com/uashraf1981/AWS/blob/master/AWS-KMS/Keys.png)

Master keys are of two types:

1. Customer-Managed Customer Master Key (CMK): Generated by Customer, rotated every year, can be deleted and most importantly, key access policy determined by the customer.

2. AWS-Managed Customer Master Key (CMK): Generated by AWS, rotated every three years, cannot be deleted and most importantly, key access policy is determined by AWS.

KMS Master Key Policies
-----------------------
You can specify the exact policies e.g.

- can be used for encryption/decryption by these users in these accounts
- can be used by applicatioin A to encrypt data only and application B to decrypt data only
- can be managed by this administrator
- you can even allow access from other accounts

![stack Overflow](https://github.com/uashraf1981/AWS/blob/master/AWS-KMS/KeyPolicy1.png)
![stack Overflow](https://github.com/uashraf1981/AWS/blob/master/AWS-KMS/KeyPolicy2.png)

Data Encryption Keys
--------------------
When you generate the data key using the Master Key by calling the *GenerateDataKey* API of the KMS, then both a plaintext version and an encrypted version of the key are produced. Plaintext version used to encrypt data then deleted. The encrypted version is stored along with data for the next time that you may need to decrypt your EBS volume or data.

The Data Encryption Keys are use to encrypt the actual data on EBS or EFS e.g. and then the data keys are also encrypted using the Master key and also stored with the data itself i.e. they are included within the data itself.

Monitoring and Compliance
-------------------------
AWS KMS is integrated with CloudTrail for all cryptographic operations so you can deliver files to an Amazon S3 bucket and  which you can later track and audit for compliance.

Programming the AWS KMS API
---------------------------
1. Using the AWS KMS CLI
------------------------------------
You can use the AWS KMS API to generate, delete, rotate keys, to encrypt decrypt data (although data keys recommended for data encryption), to encrypt and decrypt data keys and many more. You have to specify the ARN of the CMK that is to be used for encrypting the data key AND also specify the AES standard to be used.

1. Generating the data keys needs the following command plus ARN or alias of CMK with which to encrypt and length (128,256):

          aws kms generate-data-key --keyid arn:kms:us-east1.......   --key-spec AES_256

![stack Overflow](https://github.com/uashraf1981/AWS/blob/master/AWS-KMS/Command.png)


2. The encrypt command requires the reference to CMK to be used:

          aws kms encrypt --plaintext file.txt --key-id arn:kms:us-east1.... 
          
![stack Overflow](https://github.com/uashraf1981/AWS/blob/master/AWS-KMS/encrypt2.png)      

3. The decrypt command DOES NOT REQUIRE the decyprtion data key because it is stored within the cipertext:

![stack Overflow](https://github.com/uashraf1981/AWS/blob/master/AWS-KMS/decrypt.png)  

* A catch in this process is that using AWS KMS outputs the encrypted data in base64 encoded format whereas you need binary data blob for decrypting, so you have to handle the conversion from decoding base64 to binary*
         
2. AWS Encryption SDK for Java
------------------------------
Programmatically, we use the AWS Encryption SDK to encrypt and decrypt the data (strings, variables, files). This is another way of using it.

# KMS on S3

You can use the KMS Master Keys to apply encryption to a bucket, folder or files. When creating a bucket, you get the choice of using an unencrypted bucket, or encryption using just data key stored in S3, or Master key in KMS with data key in S3. Also note that *Bucket encryption policy overrides the individual folder or file policy*
